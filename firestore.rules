rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- 1. USER PROFILE RULES ---
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // --- 2. MENTOR BOOKING RULES ---
    match /mentors/{mentorId} {
      allow read: if request.auth != null;
      allow write: if false; 
    }
    
    match /mentorAvailability/{mentorId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null;
      allow create, delete: if false; 
    }

    match /sessions/{sessionId} {
      allow read: if request.auth != null && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.mentorId);
      allow write: if false; 
    }

    // --- 3. BOOKINGS COLLECTION RULES ---
    match /bookings/{bookingId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // --- 4. PEER GROUP RULES ---
    match /peerGroups/{groupId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /groupMessages/{groupId}/messages/{messageId} {
      allow read: if request.auth != null;
      allow write: if false; 
    }
    
    match /secureLedger/{ledgerId} {
      allow read, write: if false;
    }

    // --- 5. AI CHATBOT HISTORY RULES ---
    match /chats/{userId}/{document=**} {
      allow read, write: if request.auth.uid == userId;
    }

    // --- 6. DIARY RULES (UPDATED) ---
    match /diary/{entryId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // --- 7. INTENTIONS RULES ---
    match /intentions/{intentionId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // --- 8. TASKS RULES ---
    match /tasks/{taskId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // --- 9. DAILY CHECK-INS RULES ---
    match /checkins/{checkinId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // --- 10. LEGACY DIARY ENTRIES (if you have old data) ---
    match /diaryEntries/{entryId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // --- 11. GUARDIAN ALERTS (NEW - Backend Only) ---
    match /guardian_alerts/{alertId} {
      // Only backend (Firebase Admin) can write
      allow read: if request.auth != null;
      allow write: if false; 
    }

    // --- 12. COMPANY ALERTS (NEW - Backend Only) ---
    match /company_alerts/{alertId} {
      // Only backend (Firebase Admin) can write
      allow read: if request.auth != null;
      allow write: if false; 
    }

    // --- 13. EMERGENCY ALERTS (NEW - Backend Only) ---
    match /emergency_alerts/{alertId} {
      // Only backend (Firebase Admin) can write
      allow read: if request.auth != null;
      allow write: if false; 
    }
  }
}
